---
title: "Ganglioneuroblastoma & Neuroblastoma - pathanalysis"
author:
- name: Arsenij Ustjanzew (arsenij.ustjanzew@uni-mainz.de)<br><a href='https://www.unimedizin-mainz.de/imbei/'>IMBEI,
    University Medical Center Mainz</a><br>
date: "04.12.2023"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
    code_download: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary packages

```{r echo=TRUE, warning=FALSE, message=FALSE, results='hide'}
setwd("/home/rstudio/")
library("SummarizedExperiment")
library("DT")
library("DESeq2")
library("org.Hs.eg.db")
library("pheatmap")
library("dplyr")
#devtools::install_github("vqv/ggbiplot")
library("ggbiplot")
library("KEGGREST")
library("viridis")
library("igraph")
# library("EnhancedVolcano")
library("visNetwork")
library("magrittr")

source("edge_probability_functions.R")
```

# Data set analysis: Ganglioneuroblastoma vs. Neuroblastoma


# Read data

```{r}
# load graph
mgraph <- readRDS("./data/substrate_graph.Rds")

# delete edges HEX-A/B 

mgraph %<>% delete_edges("00109|00108")
mgraph %<>% delete_edges("00110|00109")

vn.mgraph <- toVisNetworkData(mgraph, idToLabel = FALSE)
vn.mgraph$edges$id <- 1:nrow(vn.mgraph$edges)

# 118 edges (reaction R01281 is duplicated once)
# edge_df <- igraph::as_data_frame(mgraph)
```


```{r}
# Read data
SE_target <- readRDS("./data/xenabrowser/TARGET_gene_expected_count.Rds")

rownames(SE_target) <- gsub("\\..*", "", rownames(SE_target))
assays(SE_target)$integerCounts <- round(((2^assays(SE_target)$counts) - 1), 0)

```

# Create count matrix, colData & rowData

```{r warning=FALSE, message=FALSE}
dds <- DESeqDataSetFromMatrix(countData= assay(SE_target, "integerCounts"), colData= colData(SE_target), design = ~ detailed_category)

rowData(dds)$geneSymbol <- AnnotationDbi::mapIds(org.Hs.eg.db, keys = rownames(dds), keytype = "ENSEMBL", column="SYMBOL")
dds <- dds[which(!is.na(rowData(dds)$geneSymbol)),]
dds <- dds[-which(duplicated(rowData(dds)$geneSymbol)),]

rownames(dds) <- rowData(dds)$geneSymbol
colData(dds)$X_primary_site[which(colData(dds)$X_primary_site == "Sympathetic\xcaNervous System")] <- "SympatheticaNervous System"

dds_NBL <- dds[, which(colData(dds)$detailed_category == "Neuroblastoma")]


#  add further colData
clinical <- read.csv("./data/TARGET_NBL_ClinicalData_Discovery_20221108.txt", sep = "\t")

clinical$TARGET.USI <- gsub("-", ".", clinical$TARGET.USI)

colData(dds_NBL)$TARRGET.USI <- rownames(colData(dds_NBL))

colData(dds_NBL)$TARRGET.USI <- gsub('.{3}$', "", colData(dds_NBL)$TARRGET.USI)

clinical <- clinical[which(clinical$TARGET.USI %in% colData(dds_NBL)$TARRGET.USI),] 

# merge data.frames
df_merge <- merge(as.data.frame(colData(dds_NBL)), clinical, by.x = which(colnames(colData(dds_NBL)) =="TARRGET.USI"), by.y = 1, all.x = TRUE)
rownames(df_merge) <- df_merge$sample
df_merge <- df_merge[rownames(colData(dds_NBL)),]

all(rownames(colData(dds_NBL)) == rownames(df_merge))

colData(dds_NBL) <- cbind(colData(dds_NBL), df_merge)
```

Filtering genes with less then 10 counts in sum for all samples

```{r warning=FALSE, message=FALSE}
keep <- rowSums(counts(dds_NBL)) >= 10
dds_NBL <- dds_NBL[keep,]

# clean categories
unique(colData(dds_NBL)$Diagnostic.Category)
colData(dds_NBL)[which(colData(dds_NBL)$Diagnostic.Category == "Ganglioneuroblastoma, nodular"),"Diagnostic.Category"] <- "Ganglioneuroblastoma"
colData(dds_NBL)[which(colData(dds_NBL)$Diagnostic.Category == "Ganglioneuroblastoma, intermixed"),"Diagnostic.Category"] <- "Ganglioneuroblastoma"

# rename to shortcuts
colData(dds_NBL)[which(colData(dds_NBL)$Diagnostic.Category == "Neuroblastoma"),"Diagnostic.Category"] <- "NB"
colData(dds_NBL)[which(colData(dds_NBL)$Diagnostic.Category == "Ganglioneuroblastoma"),"Diagnostic.Category"] <- "GNB"
colData(dds_NBL)$Diagnostic.Category <- as.factor(colData(dds_NBL)$Diagnostic.Category)

# colData(dds_NBL)[which(colData(dds_NBL)$MYCN.status == "Not Amplified"),"MYCN.status"] <- "Not.Amplified"
colData(dds_NBL)[which(colData(dds_NBL)$MYCN.status == "Not Amplified"),"MYCN.status"] <- "-MYCN"
colData(dds_NBL)[which(colData(dds_NBL)$MYCN.status == "Amplified"),"MYCN.status"] <- "+MYCN"
```

## remove samples

```{r}
dds_NBL <- dds_NBL[,-which(colData(dds_NBL)$Diagnostic.Category=="Unknown")]
colData(dds_NBL)$Diagnostic.Category <- droplevels(colData(dds_NBL)$Diagnostic.Category)

colData(dds_NBL)$MYCN.status <- as.factor(colData(dds_NBL)$MYCN.status)
dds_NBL <- dds_NBL[,-which(colData(dds_NBL)$MYCN.status=="Unknown")]
colData(dds_NBL)$MYCN.status <- droplevels(colData(dds_NBL)$MYCN.status)

dds_NBL <- dds_NBL[,-which(colData(dds_NBL)$MYCN.status=="+MYCN" & colData(dds_NBL)$Diagnostic.Category=="GNB")]
colData(dds_NBL)$MYCN.status <- droplevels(colData(dds_NBL)$MYCN.status)

```



# Normalization & log10 +1 & subset to genes of interest

```{r}
dds_NBL <- estimateSizeFactors(dds_NBL)

norm_counts <- DESeq2::counts(dds_NBL, normalized=TRUE)
norm_counts <- log10(norm_counts + 1)

# saveRDS(dds_NBL, "NB_GNB_dds_TARGET.Rds")
```

# Distance matrix

```{r fig.height= 18, , fig.width = 18}
# colData(dds_NBL)$Diagnostic.Category <- droplevels(colData(dds_NBL)$Diagnostic.Category)
DESeq2::design(dds_NBL) <- ~Diagnostic.Category
# colData(dds_NBL)$detailed_category <- droplevels(colData(dds_NBL)$detailed_category)

vsd <- vst(dds_NBL, blind=FALSE)
sampleDists <- dist(t(assay(vsd)))

library("RColorBrewer")
sampleDistMatrix <- as.matrix(sampleDists)
# rownames(sampleDistMatrix) <- as.character(vsd$Diagnostic.Category)
# colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
ann_df <- data.frame(Group=colData(dds_NBL)$Diagnostic.Category, MYCN= colData(dds_NBL)$MYCN.status)
rownames(ann_df) <- rownames(sampleDistMatrix)
p1 <- pheatmap(sampleDistMatrix, show_rownames = FALSE, show_colnames = FALSE, annotation_row = ann_df, annotation_names_row=FALSE, annotation_colors = list(Group=c(GNB="#377EB8",NB="#E41A1C"),MYCN=c(`+MYCN`="#FFFF00", `-MYCN`="#F6C077")), color=colors)

vsd_sample <- assay(vsd)[sample(rownames(assay(vsd)), 10000),]
pca <- prcomp(t(vsd_sample))

plotly::plot_ly(x = pca$x[,1], y = pca$x[,2], color=colData(dds_NBL)$Diagnostic.Category)
plotly::plot_ly(x = pca$x[,1], y = pca$x[,2], color=colData(dds_NBL)$MYCN.status)
plotly::plot_ly(x = pca$x[,3], y = pca$x[,2], color=colData(dds_NBL)$Histology)
```


# Assign gene expression to graph and compute reaction activity score (RAS)

```{r}
# create reaction activity matrix; weights are the sum of genes involved in the reaction
ras <- compute_reaction_activity(mgraph, norm_counts)

# create weighted graph per sample; weights are the sum of genes involved in the reaction
graph_list <- compute_reaction_activity(mgraph, norm_counts, output_graph=TRUE)
```

# Compute transition probability matrix

```{r}
# transition matrix (equal to random walker with max-steps 1)
transition_probability <- compute_transition_probablity(graph_list, "edge_sum", "miriam.kegg.reaction", target_node=NULL)

# transition matrix, where the product of the transition probabilities of all simple paths from the target_node are calculated  
transition_probability_paths <- compute_transition_probablity(graph_list, "edge_sum", "miriam.kegg.reaction", target_node="C01290")

# transition matrix, where if the transition probability = 1 is replaced by the recursively previous max. transition probability 
transition_probability_rec <- compute_transition_probablity(graph_list, "edge_sum", "miriam.kegg.reaction", target_node=NULL, pass_through=TRUE)
```

# Adjust reaction activity matrix by transition probabilities

```{r}
r <- intersect(rownames(ras), rownames(transition_probability))
ras_prob <- ras[r,] * transition_probability[r,]
ras_prob_path <- ras[r,] * transition_probability_paths[r,]
ras_prob_rec <- ras[r,] * transition_probability_rec[r,]


# saveRDS(ras, "./data/SVM_dashboard/NB_GNB_RAS/NB_GNB_ras.Rds")
# saveRDS(ras_prob, "./data/SVM_dashboard/NB_GNB_RAS/NB_GNB_ras_prob.Rds")
# saveRDS(ras_prob_rec, "./data/SVM_dashboard/NB_GNB_RAS/NB_GNB_ras_prob_rec.Rds")
# saveRDS(ras_prob_path, "./data/SVM_dashboard/NB_GNB_RAS/NB_GNB_ras_prob_path.Rds")
```

# PCA

## RAS

```{r}
pca <- prcomp(t(ras))

ggbiplot(pca, choices = 1:2, obs.scale = 1, var.scale = 1, varname.size = 4,
         groups = colData(dds_NBL)$Diagnostic.Category, 
         ellipse = T, circle = T, var.axes = F) +
  scale_color_discrete(name = '') +
  theme_classic() +
  theme(legend.direction = 'horizontal', legend.position = 'top', axis.text=element_text(size=12)) +
  labs(color='')
```

## RAS (scaled)

```{r}
pca <- prcomp(scale(t(ras)))

ggbiplot(pca, choices = 1:2, obs.scale = 1, var.scale = 1, varname.size = 4,
         groups = colData(dds_NBL)$Diagnostic.Category, 
         ellipse = T, circle = T, var.axes = F) +
  scale_color_discrete(name = '') +
  theme_classic() +
  theme(legend.direction = 'horizontal', legend.position = 'top', axis.text=element_text(size=12)) +
  labs(color='')
```

## RAS adjusted by trans. prob.

```{r}
pca <- prcomp(t(ras_prob))

ggbiplot(pca, choices = 1:2, obs.scale = 1, var.scale = 1, varname.size = 4,
         groups = colData(dds_NBL)$Diagnostic.Category, 
         ellipse = T, circle = T, var.axes = F) +
  scale_color_discrete(name = '') +
  theme_classic() +
  theme(legend.direction = 'horizontal', legend.position = 'top', axis.text=element_text(size=12)) +
  labs(color='')
```

## RAS adjusted by trans. prob. (scaled)

```{r}
pca <- prcomp(scale(t(ras_prob)))

ggbiplot(pca, choices = 1:2, obs.scale = 1, var.scale = 1, varname.size = 4,
         groups = colData(dds_NBL)$Diagnostic.Category, 
         ellipse = T, circle = T, var.axes = F) +
  scale_color_discrete(name = '') +
  theme_classic() +
  theme(legend.direction = 'horizontal', legend.position = 'top', axis.text=element_text(size=12)) +
  labs(color='')
```

## RAS adjusted by recursive trans. prob.

```{r}
pca <- prcomp(t(ras_prob_rec))

ggbiplot(pca, choices = 1:2, obs.scale = 1, var.scale = 1, varname.size = 4,
         groups = colData(dds_NBL)$Diagnostic.Category, 
         ellipse = T, circle = T, var.axes = F) +
  scale_color_discrete(name = '') +
  theme_classic() +
  theme(legend.direction = 'horizontal', legend.position = 'top', axis.text=element_text(size=12)) +
  labs(color='')
```

## RAS adjusted by recursive trans. prob. (scaled)

```{r}
pca <- prcomp(scale(t(ras_prob_rec)))

ggbiplot(pca, choices = 1:2, obs.scale = 1, var.scale = 1, varname.size = 4,
         groups = colData(dds_NBL)$Diagnostic.Category, 
         ellipse = T, circle = T, var.axes = F) +
  scale_color_discrete(name = '') +
  theme_classic() +
  theme(legend.direction = 'horizontal', legend.position = 'top', axis.text=element_text(size=12)) +
  labs(color='')
```

## RAS adjusted by trans. prob. per path

```{r}
remove <- apply(ras_prob_path, 1, function(x){
  all(x == 0)
})
pca <- prcomp(t(ras_prob_path)[,!remove])

ggbiplot(pca, choices = 1:2, obs.scale = 1, var.scale = 1, varname.size = 4,
         groups = colData(dds_NBL)$Diagnostic.Category, 
         ellipse = T, circle = T, var.axes = F) +
  scale_color_discrete(name = '') +
  theme_classic() +
  theme(legend.direction = 'horizontal', legend.position = 'top', axis.text=element_text(size=12)) +
  labs(color='')


```

## RAS adjusted by trans. prob. per path (scaled)

```{r}
remove <- apply(ras_prob_path, 1, function(x){
  all(x == 0)
})
pca <- prcomp(scale(t(ras_prob_path)[,!remove]))

ggbiplot(pca, choices = 1:2, obs.scale = 1, var.scale = 1, varname.size = 4,
         groups = colData(dds_NBL)$Diagnostic.Category, 
         ellipse = T, circle = T, var.axes = F) +
  scale_color_discrete(name = '') +
  theme_classic() +
  theme(legend.direction = 'horizontal', legend.position = 'top', axis.text=element_text(size=12)) +
  labs(color='')


```

# Stability of UMAPS

## ras

```{r}
library("foreach")
library("doParallel")

#create the cluster
my.cluster <- parallel::makeCluster(
  30, 
  type = "PSOCK"
  )
doParallel::registerDoParallel(cl = my.cluster)
```


```{r}
set.seed(1234)
seeds <- sample.int(1000)

# remove <- apply(ras_prob_path, 1, function(x){
#   all(x == 0)
# })

v1_ras_prob <- list()
v1_ras_prob <- foreach(s = seeds, .combine = "c", .packages="dbscan") %dopar% {
  umap_fit <-
    umap::umap(
      d  = t(ras),
      method = "naive",
      n_neighbors = 20,
      min_dist = 0.1,
      random_state = s,
      verbose = TRUE
    )
  cl <- hdbscan(umap_fit$layout, minPts = 10)
  return(list(list(seed=s, cluster=cl$cluster, umap_x=umap_fit$layout[,1], umap_y=umap_fit$layout[,2])))
  # print(cl$cluster)
  # m1 <- cbind(m1, cl$cluster)
}
#2.difgenes optimal: n_neighbors = 5; min_dist=0.1; minPts = 5

all_x <- sapply(v1_ras_prob, function(x) print(x$umap_x))
all_y <- sapply(v1_ras_prob, function(x) print(x$umap_y))
all_cluster <- sapply(v1_ras_prob, function(x) print(x$cluster))

it_df_x <- data.frame(iteration=seq(1,1000))
it_df_x <- cbind(it_df_x, t(all_x))
it_df_lg_x <- it_df_x %>%
  group_by(iteration) %>%
  tidyr::pivot_longer(colnames(dplyr::select(it_df_x, !c("iteration"))), names_to = "sample", values_to = "x-coord")

it_df_y <- data.frame(iteration=seq(1,1000))
it_df_y <- cbind(it_df_y, t(all_y))
it_df_lg_y <- it_df_y %>%
  group_by(iteration) %>%
  tidyr::pivot_longer(colnames(dplyr::select(it_df_y, !c("iteration"))), names_to = "sample", values_to = "y-coord")

it_df_xy <- as.data.frame(cbind(it_df_lg_x, it_df_lg_y))
it_df_xy <- it_df_xy[,-c(4,5)]
colnames(it_df_xy) <- c("iteration", "sample", "x", "y")

it_df_xy$sample <- as.factor(it_df_xy$sample)
it_df_xy$iteration <- as.factor(it_df_xy$iteration)
it_df_xy$cluster <- as.factor(c(all_cluster))
it_df_xy$NT_type <- as.factor(rep(colData(dds_NBL)$Diagnostic.Category, 1000))

it_df_xy$xy <- it_df_xy$x + it_df_xy$y

set.seed(123)
iterations <- sample(c(1:1000), 50)
iterations_index <- which(it_df_xy$iteration %in% iterations)


p1 <- ggplot(it_df_xy[iterations_index,], 
             aes(x = iteration, y = `xy`, group = sample)) +
  geom_line(colour="grey") +
  geom_point(aes(shape = NT_type, color = cluster), size=2) +
  theme_classic() +
  theme(
  axis.text.x = element_blank()) +
  labs(x = "Iterations",
       y = "x- + y-coordinates",
      subtitle = "RAS")


```

## ras_prob

```{r}
set.seed(1234)
seeds <- sample.int(1000)

# remove <- apply(ras_prob_path, 1, function(x){
#   all(x == 0)
# })

v1_ras_prob <- list()
v1_ras_prob <- foreach(s = seeds, .combine = "c", .packages="dbscan") %dopar% {
  umap_fit <-
    umap::umap(
      d  = t(ras_prob),
      method = "naive",
      n_neighbors = 12,
      min_dist = 0.1,
      random_state = s,
      verbose = TRUE
    )
  cl <- hdbscan(umap_fit$layout, minPts = 10)
  return(list(list(seed=s, cluster=cl$cluster, umap_x=umap_fit$layout[,1], umap_y=umap_fit$layout[,2])))
  # print(cl$cluster)
  # m1 <- cbind(m1, cl$cluster)
}
#2.difgenes optimal: n_neighbors = 5; min_dist=0.1; minPts = 5

all_x <- sapply(v1_ras_prob, function(x) print(x$umap_x))
all_y <- sapply(v1_ras_prob, function(x) print(x$umap_y))
all_cluster <- sapply(v1_ras_prob, function(x) print(x$cluster))

it_df_x <- data.frame(iteration=seq(1,1000))
it_df_x <- cbind(it_df_x, t(all_x))
it_df_lg_x <- it_df_x %>%
  group_by(iteration) %>%
  tidyr::pivot_longer(colnames(dplyr::select(it_df_x, !c("iteration"))), names_to = "sample", values_to = "x-coord")

it_df_y <- data.frame(iteration=seq(1,1000))
it_df_y <- cbind(it_df_y, t(all_y))
it_df_lg_y <- it_df_y %>%
  group_by(iteration) %>%
  tidyr::pivot_longer(colnames(dplyr::select(it_df_y, !c("iteration"))), names_to = "sample", values_to = "y-coord")

it_df_xy <- as.data.frame(cbind(it_df_lg_x, it_df_lg_y))
it_df_xy <- it_df_xy[,-c(4,5)]
colnames(it_df_xy) <- c("iteration", "sample", "x", "y")

it_df_xy$sample <- as.factor(it_df_xy$sample)
it_df_xy$iteration <- as.factor(it_df_xy$iteration)
it_df_xy$cluster <- as.factor(c(all_cluster))
it_df_xy$NT_type <- as.factor(rep(colData(dds_NBL)$Diagnostic.Category, 1000))

it_df_xy$xy <- it_df_xy$x + it_df_xy$y

set.seed(123)
iterations <- sample(c(1:1000), 50)
iterations_index <- which(it_df_xy$iteration %in% iterations)

p2 <- ggplot(it_df_xy[iterations_index,], 
             aes(x = iteration, y = `xy`, group = sample)) +
  geom_line(colour="grey") +
  geom_point(aes(shape = NT_type, color = cluster), size=2) +
  theme_classic() +
  theme(
  axis.text.x = element_blank()) +
  labs(x = "Iterations",
       y = "x- + y-coordinates",
      subtitle = "RAS adj. by TP")


```

## ras_prob_path

```{r}
set.seed(1234)
seeds <- sample.int(1000)

remove <- apply(ras_prob_path, 1, function(x){
  all(x == 0)
})

v1_ras_prob <- list()
v1_ras_prob <- foreach(s = seeds, .combine = "c", .packages="dbscan") %dopar% {
  umap_fit <-
    umap::umap(
      d  = scale(t(ras_prob_path)[,!remove]),
      method = "naive",
      n_neighbors = 12,
      min_dist = 0.1,
      random_state = s,
      verbose = TRUE
    )
  cl <- hdbscan(umap_fit$layout, minPts = 10)
  return(list(list(seed=s, cluster=cl$cluster, umap_x=umap_fit$layout[,1], umap_y=umap_fit$layout[,2])))
  # print(cl$cluster)
  # m1 <- cbind(m1, cl$cluster)
}
#2.difgenes optimal: n_neighbors = 5; min_dist=0.1; minPts = 5

all_x <- sapply(v1_ras_prob, function(x) print(x$umap_x))
all_y <- sapply(v1_ras_prob, function(x) print(x$umap_y))
all_cluster <- sapply(v1_ras_prob, function(x) print(x$cluster))

it_df_x <- data.frame(iteration=seq(1,1000))
it_df_x <- cbind(it_df_x, t(all_x))
it_df_lg_x <- it_df_x %>%
  group_by(iteration) %>%
  tidyr::pivot_longer(colnames(dplyr::select(it_df_x, !c("iteration"))), names_to = "sample", values_to = "x-coord")

it_df_y <- data.frame(iteration=seq(1,1000))
it_df_y <- cbind(it_df_y, t(all_y))
it_df_lg_y <- it_df_y %>%
  group_by(iteration) %>%
  tidyr::pivot_longer(colnames(dplyr::select(it_df_y, !c("iteration"))), names_to = "sample", values_to = "y-coord")

it_df_xy <- as.data.frame(cbind(it_df_lg_x, it_df_lg_y))
it_df_xy <- it_df_xy[,-c(4,5)]
colnames(it_df_xy) <- c("iteration", "sample", "x", "y")

it_df_xy$sample <- as.factor(it_df_xy$sample)
it_df_xy$iteration <- as.factor(it_df_xy$iteration)
it_df_xy$cluster <- as.factor(c(all_cluster))
it_df_xy$NT_type <- as.factor(rep(colData(dds_NBL)$Diagnostic.Category, 1000))

it_df_xy$xy <- it_df_xy$x + it_df_xy$y

set.seed(123)
iterations <- sample(c(1:1000), 50)
iterations_index <- which(it_df_xy$iteration %in% iterations)

p3 <- ggplot(it_df_xy[iterations_index,], 
             aes(x = iteration, y = `xy`, group = sample)) +
  geom_line(colour="grey") +
  geom_point(aes(shape = NT_type, color = cluster), size=2) +
  theme_classic() +
  theme(
  axis.text.x = element_blank()) +
  labs(x = "Iterations",
       y = "x- + y-coordinates",
      subtitle = "RAS adj. by TP along paths")


```

## ras_prob_rec

```{r}
set.seed(1234)
seeds <- sample.int(1000)

# remove <- apply(ras_prob_path, 1, function(x){
#   all(x == 0)
# })

v1_ras_prob <- list()
v1_ras_prob <- foreach(s = seeds, .combine = "c", .packages="dbscan") %dopar% {
  umap_fit <-
    umap::umap(
      d  = t(ras_prob_rec),
      method = "naive",
      n_neighbors = 12,
      min_dist = 0.1,
      random_state = s,
      verbose = TRUE
    )
  cl <- hdbscan(umap_fit$layout, minPts = 10)
  return(list(list(seed=s, cluster=cl$cluster, umap_x=umap_fit$layout[,1], umap_y=umap_fit$layout[,2])))
  # print(cl$cluster)
  # m1 <- cbind(m1, cl$cluster)
}
#2.difgenes optimal: n_neighbors = 5; min_dist=0.1; minPts = 5

all_x <- sapply(v1_ras_prob, function(x) print(x$umap_x))
all_y <- sapply(v1_ras_prob, function(x) print(x$umap_y))
all_cluster <- sapply(v1_ras_prob, function(x) print(x$cluster))

it_df_x <- data.frame(iteration=seq(1,1000))
it_df_x <- cbind(it_df_x, t(all_x))
it_df_lg_x <- it_df_x %>%
  group_by(iteration) %>%
  tidyr::pivot_longer(colnames(dplyr::select(it_df_x, !c("iteration"))), names_to = "sample", values_to = "x-coord")

it_df_y <- data.frame(iteration=seq(1,1000))
it_df_y <- cbind(it_df_y, t(all_y))
it_df_lg_y <- it_df_y %>%
  group_by(iteration) %>%
  tidyr::pivot_longer(colnames(dplyr::select(it_df_y, !c("iteration"))), names_to = "sample", values_to = "y-coord")

it_df_xy <- as.data.frame(cbind(it_df_lg_x, it_df_lg_y))
it_df_xy <- it_df_xy[,-c(4,5)]
colnames(it_df_xy) <- c("iteration", "sample", "x", "y")

it_df_xy$sample <- as.factor(it_df_xy$sample)
it_df_xy$iteration <- as.factor(it_df_xy$iteration)
it_df_xy$cluster <- as.factor(c(all_cluster))
it_df_xy$NT_type <- as.factor(rep(colData(dds_NBL)$Diagnostic.Category, 1000))

it_df_xy$xy <- it_df_xy$x + it_df_xy$y

set.seed(123)
iterations <- sample(c(1:1000), 50)
iterations_index <- which(it_df_xy$iteration %in% iterations)

p4 <- ggplot(it_df_xy[iterations_index,], 
             aes(x = iteration, y = `xy`, group = sample)) +
  geom_line(colour="grey") +
  geom_point(aes(shape = NT_type, color = cluster), size=2) +
  theme_classic() +
  theme(
  axis.text.x = element_blank()) +
  labs(x = "Iterations",
       y = "x- + y-coordinates",
      subtitle = "Recursive RAS adj. by TP")

```

## multipanel

```{r}
library(multipanelfigure)
library(grid)
cols <- 1
rows <- 4
figure <- multi_panel_figure(
  width = 250,
  columns = cols,
  height = 250,
  rows = rows)

figure %<>% fill_panel(p1)
figure %<>% fill_panel(p2)
figure %<>% fill_panel(p3)
figure %<>% fill_panel(p4)

figure
# save_multi_panel_figure(figure, "UMAP_stability_NB_GN.png", dpi = 300)

```

# UMAP

## RAS

```{r}
umap_fit <- umap::umap(d  = t(ras), #sample norm_counts
                           method = "naive",
                           n_neighbors = 12,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 121,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
```


```{r}
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Diagnostic.Category))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
p
```

```{r}
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$MYCN.status))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
library("foreach")
library("doParallel")

#create the cluster
my.cluster <- parallel::makeCluster(
  30, 
  type = "PSOCK"
  )
doParallel::registerDoParallel(cl = my.cluster)

set.seed(1234)
seeds <- sample.int(1000)
# m1_ras <- matrix(ncol = 0, nrow = nrow(ras))
# m1_ras <- foreach(s = seeds, .combine = "cbind", .packages="dbscan") %dopar% {
#   umap_fit <-
#     umap::umap(
#       d  = scale(t(ras)),
#       method = "naive",
#       n_neighbors = 12,
#       min_dist = 0.1,
#       random_state = s,
#       verbose = TRUE
#     )
#   cl <- hdbscan(umap_fit$layout, minPts = 10)
#   return(cl$cluster)
#   # print(cl$cluster)
#   # m1 <- cbind(m1, cl$cluster)
# }

v1_ras_prob <- list()
v1_ras_prob <- foreach(s = seeds, .combine = "c", .packages="dbscan") %dopar% {
  umap_fit <-
    umap::umap(
      d  = t(ras),
      method = "naive",
      n_neighbors = 12,
      min_dist = 0.1,
      random_state = s,
      verbose = TRUE
    )
  cl <- hdbscan(umap_fit$layout, minPts = 10)
  return(list(list(seed=s, cluster=cl$cluster, umap_x=umap_fit$layout[,1], umap_y=umap_fit$layout[,2])))
  # print(cl$cluster)
  # m1 <- cbind(m1, cl$cluster)
}
#2.difgenes optimal: n_neighbors = 5; min_dist=0.1; minPts = 5

all_x <- sapply(v1_ras_prob, function(x) print(x$umap_x))
all_y <- sapply(v1_ras_prob, function(x) print(x$umap_y))
all_cluster <- sapply(v1_ras_prob, function(x) print(x$cluster))

all_xy <- cbind(all_x, all_y)

# sampleDists <- dist(all_xy)

library("RColorBrewer")
# sampleDistMatrix <- as.matrix(sampleDists)
# rownames(sampleDistMatrix) <- as.character(vsd$Diagnostic.Category)
# colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
ann_df <- data.frame(
  Group=colData(dds_NBL)$Diagnostic.Category, 
  MYCN= colData(dds_NBL)$MYCN.status,
  Cluster = as.factor(all_cluster[,447])
  )
rownames(ann_df) <- rownames(all_xy)
# plotly::plot_ly(x=all_x[,15], y=all_y[,15], color=as.factor(all_cluster[,1]))
# pheatmap(sampleDistMatrix, show_rownames = FALSE, show_colnames = FALSE, annotation_row = ann_df, annotation_names_row=FALSE, annotation_colors = list(Group=c(GNB="#377EB8",NB="#E41A1C"),MYCN=c(Amplified="#FFFF00", `Not.Amplified`="#F6C077")))

pheatmap(1-cor(t(all_xy)), show_rownames = FALSE, show_colnames = FALSE, annotation_row = ann_df, annotation_names_row=FALSE, annotation_colors = list(
  Group=c(GNB="#377EB8",NB="#E41A1C"),
  MYCN=c(`+MYCN`="#FFFF00", `-MYCN`="#F6C077"),
  Cluster=c(
    "0"="#F8766D", # red
    "1"="#A3A500", # yellow
    "2"="#00BF7D", # green
    "3"="#00B0F6", # blue
    "4"="#E76BF3") # violett
  ), 
  clustering_method = "complete")
# corrplot::corrplot(cor(t(all_xy)), order="hclust")

# plotly::plot_ly(x=all_x[1,], y=all_y[1,])
# energy::dcor(all_x[3,], all_y[3,])

clustn <- apply(all_cluster, 2, function(x){
  x <- x[x!=0]
  # print(x)
  length(unique(x))
})
table(as.factor(clustn))
plot(as.factor(clustn))
# m_sub <-m[,clustn==3]

c <- cutree(hclust(as.dist(1-cor(t(all_xy)))),k=2)
plotly::plot_ly(x=all_x[,509], y=all_y[,509], color=as.factor(c))
plotly::plot_ly(x=all_x[,6], y=all_y[,6], color=as.factor(all_cluster[,6]))
plotly::plot_ly(x=all_x[,9], y=all_y[,9], color=colData(dds_NBL)$MYCN.status)
```



## RAS (scaled)

```{r}
umap_fit <- umap::umap(d  = scale(t(ras)), #sample norm_counts
                           method = "naive",
                           n_neighbors = 8,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 121,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
```


```{r}
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Diagnostic.Category))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$MYCN.status))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

## RAS adjusted by trans. prob. per path

```{r}
umap_fit <- umap::umap(d  = t(ras_prob_path)[,!remove], #sample norm_counts
                           method = "naive",
                           n_neighbors = 8,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 121,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
```


```{r}
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Diagnostic.Category))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
# Percent.Tumor <- gsub("-.*","",colData(dds_NBL)$Percent.Tumor)
# Percent.Tumor <- as.numeric(Percent.Tumor)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$MYCN.status))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
# Percent.Tumor <- gsub("-.*","",colData(dds_NBL)$Percent.Tumor)
# Percent.Tumor <- as.numeric(Percent.Tumor)
# Percent.Necrosis <- gsub("-.*","",colData(dds_NBL)$Percent.Necrosis)
# Percent.Necrosis <- as.numeric(Percent.Necrosis)


p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Histology))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

## RAS adjusted by trans. prob. per path (scaled)

```{r}
umap_fit <- umap::umap(d  = scale(t(ras_prob_path)[,!remove]), #sample norm_counts
                           method = "naive",
                           n_neighbors = 8,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 121,
                           # transform_state = input$transform_state,
                           verbose = TRUE)

# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Diagnostic.Category))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```


```{r}
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$MYCN.status))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```


## RAS adjusted by recursive trans. prob.

```{r}
umap_fit <- umap::umap(d  = t(ras_prob_rec), #sample norm_counts
                           method = "naive",
                           n_neighbors = 10,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 121,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Diagnostic.Category))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
       color = "Group",
      subtitle = "UMAP plot")
p
```

```{r}
# Percent.Tumor <- gsub("-.*","",colData(dds_NBL)$Percent.Tumor)
# Percent.Tumor <- as.numeric(Percent.Tumor)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$MYCN.status))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
       color = "MYCN.status",
      subtitle = "UMAP plot")
p
```

```{r}
# Percent.Tumor <- gsub("-.*","",colData(dds_NBL)$Percent.Tumor)
# Percent.Tumor <- as.numeric(Percent.Tumor)
# Percent.Necrosis <- gsub("-.*","",colData(dds_NBL)$Percent.Necrosis)
# Percent.Necrosis <- as.numeric(Percent.Necrosis)


p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Histology))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

## RAS adjusted by recursive trans. prob. (scaled)

```{r}
umap_fit <- umap::umap(d  = scale(t(ras_prob_rec)), #sample norm_counts
                           method = "naive",
                           n_neighbors = 6,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 123,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Diagnostic.Category))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
# Percent.Tumor <- gsub("-.*","",colData(dds_NBL)$Percent.Tumor)
# Percent.Tumor <- as.numeric(Percent.Tumor)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$MYCN.status))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
# Percent.Tumor <- gsub("-.*","",colData(dds_NBL)$Percent.Tumor)
# Percent.Tumor <- as.numeric(Percent.Tumor)
# Percent.Necrosis <- gsub("-.*","",colData(dds_NBL)$Percent.Necrosis)
# Percent.Necrosis <- as.numeric(Percent.Necrosis)


p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Histology))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

## RAS adjusted by trans. prob.

```{r}
umap_fit <- umap::umap(d  = t(ras_prob), #sample norm_counts
                           method = "naive",
                           n_neighbors = 6,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 123,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Diagnostic.Category))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$MYCN.status))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```


## RAS adjusted by trans. prob. (scaled)

```{r}
umap_fit <- umap::umap(d  = scale(t(ras_prob)), #sample norm_counts
                           method = "naive",
                           n_neighbors = 6,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 123,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
# plot(umap_fit$layout)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Diagnostic.Category))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
# Percent.Tumor <- gsub("-.*","",colData(dds_NBL)$Percent.Tumor)
# Percent.Tumor <- as.numeric(Percent.Tumor)
p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$MYCN.status))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

```{r}
# Percent.Tumor <- gsub("-.*","",colData(dds_NBL)$Percent.Tumor)
# Percent.Tumor <- as.numeric(Percent.Tumor)
# Percent.Necrosis <- gsub("-.*","",colData(dds_NBL)$Percent.Necrosis)
# Percent.Necrosis <- as.numeric(Percent.Necrosis)


p <- as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             label = rownames(umap_fit$layout),
             color = colData(dds_NBL)$Histology))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
plotly::ggplotly(p)
```

# Hierarchical DBSCAN clustering

```{r}
umap_fit <- umap::umap(d  = t(ras), #sample norm_counts
                           method = "naive",
                           n_neighbors = 12,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = seeds[447],
                           # transform_state = input$transform_state,
                           verbose = TRUE)

library("dbscan")

cl <- hdbscan(umap_fit$layout, minPts = 10)

as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             color = as.factor(cl$cluster)))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")

df <- data.frame(UMAP1 = umap_fit$layout[,1],
                 UMAP2 = umap_fit$layout[,2],
                 Cluster = as.factor(cl$cluster),
                 Group = colData(dds_NBL)$Diagnostic.Category,
                 MYCN.status = colData(dds_NBL)$MYCN.status)  
  
ggplot(df, aes(x = UMAP1,
             y = UMAP2,
             color = MYCN.status,
             shape = Group))+
  geom_point()+
  theme_classic()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")

ggplot(df, aes(x = UMAP1,
             y = UMAP2,
             color = Cluster,
             shape = Group))+
  geom_point()+
  theme_classic()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")

ggplot(df, aes(x = UMAP1,
             y = UMAP2,
             color = Cluster,
             shape = Group))+
  geom_point()+
  theme_classic()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")

ggplot(df, aes(x = UMAP1,
             y = UMAP2,
             color = ras["R06025",],
             shape = Group))+
  geom_point()+
  theme_classic()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot colored by R06025",
      color='RAS')

ggplot(df, aes(x = UMAP1,
             y = UMAP2,
             color = norm_counts["MYCN",],
             shape = Group))+
  geom_point()+
  theme_classic()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot colored by log10( normalized MYCN )",
      color='Expression')

```



# Identify markers per cluster

```{r}
library(scran)


markers <- scran::findMarkers(
    x = ras,
    group = as.factor(cl$cluster),
    test.type = "t",
    pval.type = "all",
    #restrict = input$restrict,
    #exclude = input$exclude,
    direction = "up",
    #lfc = input$lfc,
    #min.prop = input$min.prop,
    full.stats = TRUE,
    sorted = TRUE
  )
```


## Characteristic reactions for cluster 1

```{r}
DT::datatable(as.data.frame(markers$`1`))
```

```{r}
as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             color = ras_prob_rec["R03355",]))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")


```

```{r}
sig_r <- rownames(as.data.frame(markers$`1`)[which(as.data.frame(markers$`1`)$p.value <= 0.05),])

ann_df <- data.frame(Group=colData(dds_NBL)$Diagnostic.Category, MYCN= colData(dds_NBL)$MYCN.status, Hist=colData(dds_NBL)$Histology, cluster=as.factor(cl$cluster))
rownames(ann_df) <- rownames(colData(dds_NBL))
pheatmap(ras_prob_rec[sig_r,], show_colnames = FALSE, annotation_col = ann_df, show_rownames = FALSE, scale = "row")
```

## Characteristic reactions for cluster 2

```{r}
DT::datatable(as.data.frame(markers$`2`))
```

## Characteristic reactions for cluster 3

```{r}
DT::datatable(as.data.frame(markers$`3`))
```

# Reactions boxplot

```{r}
r_interest <- c(
  "R05938",
  "R05956",
  "R05957",
  "R05937",
  "R05939",
  "R05941",
  "R05942",
  "R05943",
  "R05940",
  "R05946",
  "R05948",
  "R05949",
  "R05950",
  "R05947",
  "R05952",
  "R05953"
  )
```


## RAS

```{r}
score_group <- t(ras) %>% as.data.frame()
score_group$Diagnostic.Category <- as.factor(colData(dds_NBL)$Diagnostic.Category)
# score_group <- as.data.frame(score_group)
score_group_lg <- score_group %>%
  group_by(Diagnostic.Category) %>%
  tidyr::pivot_longer(colnames(dplyr::select(score_group, !c("Diagnostic.Category"))), names_to = "reaction", values_to = "value")

score_group_lg$Diagnostic.Category <- as.factor(score_group_lg$Diagnostic.Category)

```

```{r fig.width = 18}
ggplot(score_group_lg[which(score_group_lg$reaction %in% r_interest),], aes(x=Diagnostic.Category, y=value, group=Diagnostic.Category)) + 
  geom_boxplot(aes(fill=Diagnostic.Category)) + facet_wrap(~ reaction, scales= "free", ncol = 16) + theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## RAS adjusted by transition prob.

```{r}
score_group <- t(ras_prob) %>% as.data.frame()
score_group$Diagnostic.Category <- as.factor(colData(dds_NBL)$Diagnostic.Category)
# score_group <- as.data.frame(score_group)
score_group_lg <- score_group %>%
  group_by(Diagnostic.Category) %>%
  tidyr::pivot_longer(colnames(dplyr::select(score_group, !c("Diagnostic.Category"))), names_to = "reaction", values_to = "value")

score_group_lg$Diagnostic.Category <- as.factor(score_group_lg$Diagnostic.Category)

```


```{r fig.width = 18}
ggplot(score_group_lg[which(score_group_lg$reaction %in% r_interest),], aes(x=Diagnostic.Category, y=value, group=Diagnostic.Category)) + 
  geom_boxplot(aes(fill=Diagnostic.Category)) + facet_wrap(~ reaction, scales= "free", ncol = 16) + theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


## RAS adjusted by recursive transition prob.

```{r}
score_group <- t(ras_prob_rec) %>% as.data.frame()
score_group$Diagnostic.Category <- as.factor(colData(dds_NBL)$Diagnostic.Category)
# score_group <- as.data.frame(score_group)
score_group_lg <- score_group %>%
  group_by(Diagnostic.Category) %>%
  tidyr::pivot_longer(colnames(dplyr::select(score_group, !c("Diagnostic.Category"))), names_to = "reaction", values_to = "value")

score_group_lg$Diagnostic.Category <- as.factor(score_group_lg$Diagnostic.Category)

```


```{r fig.width = 18}
ggplot(score_group_lg[which(score_group_lg$reaction %in% r_interest),], aes(x=Diagnostic.Category, y=value, group=Diagnostic.Category)) + 
  geom_boxplot(aes(fill=Diagnostic.Category)) + facet_wrap(~ reaction, scales= "free", ncol = 16) + theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## RAS adjusted by transition prob. of path

```{r}
score_group <- t(ras_prob_path) %>% as.data.frame()
score_group$Diagnostic.Category <- as.factor(colData(dds_NBL)$Diagnostic.Category)
# score_group <- as.data.frame(score_group)
score_group_lg <- score_group %>%
  group_by(Diagnostic.Category) %>%
  tidyr::pivot_longer(colnames(dplyr::select(score_group, !c("Diagnostic.Category"))), names_to = "reaction", values_to = "value")

score_group_lg$Diagnostic.Category <- as.factor(score_group_lg$Diagnostic.Category)
```


```{r fig.width = 18}
ggplot(score_group_lg[which(score_group_lg$reaction %in% r_interest),], aes(x=Diagnostic.Category, y=value, group=Diagnostic.Category)) + 
  geom_boxplot(aes(fill=Diagnostic.Category)) + facet_wrap(~ reaction, scales= "free", ncol = 16) + theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

# MYCN vs. B3GALT4 correlation

```{r warning=FALSE, message=FALSE}
plotly::plot_ly(x=norm_counts["MYCN",which(colData(dds_NBL)$Diagnostic.Category == "NB")], y = norm_counts["B3GALT4",which(colData(dds_NBL)$Diagnostic.Category == "NB")], color=colData(dds_NBL)[which(colData(dds_NBL)$Diagnostic.Category == "NB"),"MYCN.status"], type = "scatter") %>% 
  plotly::layout(xaxis = list(title = 'log10( MYCN expression )'), 
         yaxis = list(title = 'log10( B3GALT4 expression )'))
```

```{r}
#(https://link.springer.com/article/10.1007/s10462-019-09781-w Semantic association computation: a comprehensive survey. Shahida Jabeen)

df <- data.frame(MYCN=norm_counts["MYCN",which(colData(dds_NBL)$Diagnostic.Category == "NB")],
                 B3GALT4=norm_counts["B3GALT4",which(colData(dds_NBL)$Diagnostic.Category == "NB")],
                 MYCN.status=colData(dds_NBL)[which(colData(dds_NBL)$Diagnostic.Category == "NB"),"MYCN.status"])
cor.all <- cor(df$MYCN, df$B3GALT4, method = 'pearson')
cor.amp <- cor(df$MYCN[df$MYCN.status=="+MYCN"], df$B3GALT4[df$MYCN.status=="+MYCN"], method = 'pearson')
cor.notamp <- cor(df$MYCN[df$MYCN.status=="-MYCN"], df$B3GALT4[df$MYCN.status=="-MYCN"], method = 'pearson')

cor.all <- cor(df$MYCN, df$B3GALT4, method = 'spearman')
cor.amp <- cor(df$MYCN[df$MYCN.status=="+MYCN"], df$B3GALT4[df$MYCN.status=="+MYCN"], method = 'spearman')
cor.notamp <- cor(df$MYCN[df$MYCN.status=="-MYCN"], df$B3GALT4[df$MYCN.status=="-MYCN"], method = 'spearman')
```

```{r}
ggplot(df, aes(MYCN, B3GALT4, colour = MYCN.status)) + geom_point() + geom_smooth(alpha=0.3, method="lm")

```



```{r warning=FALSE, message=FALSE}
brewer.pal(n=2,"Set1")


p1 <- plotly::plot_ly( showlegend = FALSE, y=norm_counts["MYCN",], x = norm_counts["B3GALT4",], type = "scatter", mode="markers", symbol=colData(dds_NBL)$MYCN.status, color = colData(dds_NBL)$Diagnostic.Category, colors = c("#377EB8","#E41A1C")) %>% 
  plotly::layout(yaxis = list(title = 'log10( MYCN expression )'), 
         xaxis = list(title = 'log10( B3GALT4 expression )')
         #legend = list(x = 0.1, y = 0.1, bordercolor = "#000",bgcolor = "#fff", borderwidth="1")
         )

p2 <- plotly::plot_ly( showlegend = FALSE, y=norm_counts["MYCN",], x = norm_counts["ST8SIA1",], type = "scatter", mode="markers", symbol=colData(dds_NBL)$MYCN.status, color = colData(dds_NBL)$Diagnostic.Category, colors = c("#377EB8","#E41A1C")) %>% 
  plotly::layout(yaxis = list(title = 'log10( MYCN expression )'), 
         xaxis = list(title = 'log10( ST8SIA1 expression )'))
         
p3 <- plotly::plot_ly(y=norm_counts["MYCN",], x = norm_counts["B4GALNT1",], type = "scatter", mode="markers", symbol=colData(dds_NBL)$MYCN.status, color = colData(dds_NBL)$Diagnostic.Category, colors = c("#377EB8","#E41A1C")) %>% 
  plotly::layout(yaxis = list(title = 'log10( MYCN expression )'), 
         xaxis = list(title = 'log10( B4GALNT1 expression )'))


fig <- subplot(p1, p2, p3, shareY = TRUE, titleX = TRUE)
```

```{r}
#(https://link.springer.com/article/10.1007/s10462-019-09781-w Semantic association computation: a comprehensive survey. Shahida Jabeen)

df <- data.frame(MYCN=norm_counts["MYCN",which(colData(dds_NBL)$type == "NB")],
                 B3GALT4=norm_counts["B3GALT4",which(colData(dds_NBL)$type == "NB")])


NB_MYCN_pos <- which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "Amplified")
NB_MYCN_neg <- which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "Not.Amplified")
GNB <- which(colData(dds_NBL)$Diagnostic.Category == "GNB")
NB_GNB_MYCN_pos <- which((colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "Amplified") | colData(dds_NBL)$Diagnostic.Category == "GNB")
NB_GNB_MYCN_neg <- which((colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "Not.Amplified") | colData(dds_NBL)$Diagnostic.Category == "GNB")
NB_GNB <- which(colData(dds_NBL)$Diagnostic.Category == "NB" | colData(dds_NBL)$Diagnostic.Category == "GNB")

df <- data.frame(MYCN=norm_counts["MYCN",NB_GNB],
                 B3GALT4=norm_counts["B3GALT4",NB_GNB],
                 ST8SIA1=norm_counts["ST8SIA1",NB_GNB],
                 B4GALNT1=norm_counts["B4GALNT1",NB_GNB])
cor(df$MYCN, df$B3GALT4, method = 'pearson')
cor(df$MYCN, df$ST8SIA1, method = 'pearson')
cor(df$MYCN, df$B4GALNT1, method = 'pearson')
```

```{r}
ggplot(df, aes(MYCN, B3GALT4)) + geom_point() + geom_smooth(alpha=0.3, method="lm")

```


# p-value & log2FC computation Ganglioneuroblastoma vs. Neuroblastoma


See seperate file NB_GNB_FC_image.Rmd

# summary of the pathway activity

```{r}
r_604 <- keggLink("reaction","map00604") # ganglio series
r_600 <- keggLink("reaction","map00600") # sphingolipid metabolism
r_603 <- keggLink("reaction","map00603") # globo and isoglobo series
r_601 <- keggLink("reaction","map00601") # lacto and neolacto series

r_604 <- gsub("rn:", "", r_604)
r_600 <- gsub("rn:", "", r_600)
r_603 <- gsub("rn:", "", r_603)
r_601 <- gsub("rn:", "", r_601)

# type | pathway | mean | sd

# 604
r_604_sum_GN <- colSums(ras[which(rownames(ras) %in% r_604),which(colData(dds_NBL)$Diagnostic.Category == "GNB")])
r_604_mean_GN <- mean(r_604_sum_GN)
# r_604_mean_GN <- r_604_mean_GN / 15
r_604_sd_GN <- sd(r_604_sum_GN)

r_604_sum_NB_mycn <- colSums(ras[which(rownames(ras) %in% r_604),which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "+MYCN")])
r_604_mean_NB_mycn <- mean(r_604_sum_NB_mycn)
# r_604_mean_NB_mycn <- r_604_mean_NB_mycn / 15
r_604_sd_NB_mycn <- sd(r_604_sum_NB_mycn)

r_604_sum_NB <- colSums(ras[which(rownames(ras) %in% r_604),which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "-MYCN")])
r_604_mean_NB <- mean(r_604_sum_NB)
# r_604_mean_NB <- r_604_mean_NB / 15
r_604_sd_NB <- sd(r_604_sum_NB)

# 603
r_603_sum_GN <- colSums(ras[which(rownames(ras) %in% r_603),which(colData(dds_NBL)$Diagnostic.Category == "GNB")])
r_603_mean_GN <- mean(r_603_sum_GN)
# r_603_mean_GN <- r_603_mean_GN / 16
r_603_sd_GN <- sd(r_603_sum_GN)

r_603_sum_NB_mycn <- colSums(ras[which(rownames(ras) %in% r_603),which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "+MYCN")])
r_603_mean_NB_mycn <- mean(r_603_sum_NB_mycn)
# r_603_mean_NB_mycn <- r_603_mean_NB_mycn / 16
r_603_sd_NB_mycn <- sd(r_603_sum_NB_mycn)

r_603_sum_NB <- colSums(ras[which(rownames(ras) %in% r_603),which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "-MYCN")])
r_603_mean_NB <- mean(r_603_sum_NB)
# r_603_mean_NB <- r_603_mean_NB / 16
r_603_sd_NB <- sd(r_603_sum_NB)

# 601
r_601_sum_GN <- colSums(ras[which(rownames(ras) %in% r_601),which(colData(dds_NBL)$Diagnostic.Category == "GNB")])
r_601_mean_GN <- mean(r_601_sum_GN)
# r_601_mean_GN <- r_601_mean_GN / 28
r_601_sd_GN <- sd(r_601_sum_GN)

r_601_sum_NB_mycn <- colSums(ras[which(rownames(ras) %in% r_601),which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "+MYCN")])
r_601_mean_NB_mycn <- mean(r_601_sum_NB_mycn)
# r_601_mean_NB_mycn <- r_601_mean_NB_mycn / 28
r_601_sd_NB_mycn <- sd(r_601_sum_NB_mycn)

r_601_sum_NB <- colSums(ras[which(rownames(ras) %in% r_601),which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "-MYCN")])
r_601_mean_NB <- mean(r_601_sum_NB)
# r_601_mean_NB <- r_601_mean_NB / 28
r_601_sd_NB <- sd(r_601_sum_NB)


# 600
r_600_sum_GN <- colSums(ras[which(rownames(ras) %in% r_600),which(colData(dds_NBL)$Diagnostic.Category == "GNB")])
r_600_mean_GN <- mean(r_600_sum_GN)
# r_600_mean_GN <- r_600_mean_GN / 53
r_600_sd_GN <- sd(r_600_sum_GN)

r_600_sum_NB_mycn <- colSums(ras[which(rownames(ras) %in% r_600),which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "+MYCN")])
r_600_mean_NB_mycn <- mean(r_600_sum_NB_mycn)
# r_600_mean_NB_mycn <- r_600_mean_NB_mycn / 53
r_600_sd_NB_mycn <- sd(r_600_sum_NB_mycn)

r_600_sum_NB <- colSums(ras[which(rownames(ras) %in% r_600),which(colData(dds_NBL)$Diagnostic.Category == "NB" & colData(dds_NBL)$MYCN.status == "-MYCN")])
r_600_mean_NB <- mean(r_600_sum_NB)
# r_600_mean_NB <- r_600_mean_NB / 53
r_600_sd_NB <- sd(r_600_sum_NB)


pa_df <- data.frame(type=c("GNB", "NB_MYCN", "NB", 
                           "GNB", "NB_MYCN", "NB", 
                           "GNB", "NB_MYCN", "NB", 
                           "GNB", "NB_MYCN", "NB"),
                    pathway = c("Ganglio", "Ganglio", "Ganglio", 
                                "Globo", "Globo", "Globo", 
                                "Lacto", "Lacto", "Lacto", 
                                "Sphingo", "Sphingo", "Sphingo"),
                    mean = c(r_604_mean_GN, r_604_mean_NB_mycn, r_604_mean_NB, 
                             r_603_mean_GN, r_603_mean_NB_mycn, r_603_mean_NB,
                             r_601_mean_GN, r_601_mean_NB_mycn, r_601_mean_NB, 
                             r_600_mean_GN, r_600_mean_NB_mycn, r_600_mean_NB),
                    sd = c(r_604_sd_GN, r_604_sd_NB_mycn, r_604_sd_NB, 
                           r_603_sd_GN, r_603_sd_NB_mycn, r_603_sd_NB, 
                           r_601_sd_GN, r_601_sd_NB_mycn, r_601_sd_NB, 
                           r_600_sd_GN, r_600_sd_NB_mycn, r_600_sd_NB))

ggplot(pa_df, aes(x=pathway, y=mean, fill=type)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_brewer(palette="Paired") + 
  theme_minimal()
```


# Heatmaps

## RAS

```{r}
mapal <- colorRampPalette(RColorBrewer::brewer.pal(11,"RdBu"))(256)
```

```{r fig.width = 15}
anno <- as.data.frame(colData(dds_NBL)$Diagnostic.Category)
rownames(anno) <- colnames(ras)
pheatmap::pheatmap(ras[r_interest,], cluster_cols = T,color = rev(mapal), scale = "row", annotation_col = anno, show_colnames = F)
```

## RAS adjusted by trans. prob.

```{r fig.width = 15}
anno <- as.data.frame(colData(dds_NBL)$Diagnostic.Category)
rownames(anno) <- colnames(ras)
pheatmap::pheatmap(ras_prob[r_interest,], cluster_cols = T,color = rev(mapal), scale = "row", annotation_col = anno, show_colnames = F)
```

## RAS adjusted by recursive trans. prob.

```{r fig.width = 15}
anno <- as.data.frame(colData(dds_NBL)$Diagnostic.Category)
rownames(anno) <- colnames(ras)
pheatmap::pheatmap(ras_prob_rec[r_interest,], cluster_cols = T,color = rev(mapal), scale = "row", annotation_col = anno, show_colnames = F)
```


## RAS adjusted by trans. prob. of path

```{r fig.width = 15}
anno <- as.data.frame(colData(dds_NBL)$Diagnostic.Category)
rownames(anno) <- colnames(ras)
pheatmap::pheatmap(ras_prob_path[r_interest,], cluster_cols = T,color = rev(mapal), scale = "row", annotation_col = anno, show_colnames = F)
```

# Reactions summed up to series

## RAS 

```{r fig.width = 15}
S0 <- c("R05938", "R05956", "R05957", "R05959", "R05958")
Sa <- c("R05939", "R05941", "R05942", "R05943", "R05945")
Sb <- c("R05946", "R05948", "R05949", "R05950", "R05951")
Sc <- c("R05952", "R05953", "R05947")

series_df <- data.frame(
  S0_sum = colSums(ras[S0,]),
  Sa_sum = colSums(ras[Sa,]),
  Sb_sum = colSums(ras[Sb,]),
  Sc_sum = colSums(ras[Sc,])
)

anno <- as.data.frame(colData(dds_NBL)$Diagnostic.Category)
rownames(anno) <- colnames(ras)
pheatmap::pheatmap(t(series_df), cluster_cols = T,color = rev(mapal), scale = "row", annotation_col = anno, show_colnames = F)
```

## RAS adjusted by trans. prob.

```{r fig.width = 15}
series_df <- data.frame(
  S0_sum = colSums(ras_prob[S0,]),
  Sa_sum = colSums(ras_prob[Sa,]),
  Sb_sum = colSums(ras_prob[Sb,]),
  Sc_sum = colSums(ras_prob[Sc,])
)

anno <- as.data.frame(colData(dds_NBL)$Diagnostic.Category)
rownames(anno) <- colnames(ras)
pheatmap::pheatmap(t(series_df), cluster_cols = T,color = rev(mapal), scale = "row", annotation_col = anno, show_colnames = F)
```

## RAS adjusted by recursive trans. prob.

```{r fig.width = 15}
series_df <- data.frame(
  S0_sum = colSums(ras_prob_rec[S0,]),
  Sa_sum = colSums(ras_prob_rec[Sa,]),
  Sb_sum = colSums(ras_prob_rec[Sb,]),
  Sc_sum = colSums(ras_prob_rec[Sc,])
)

anno <- as.data.frame(colData(dds_NBL)$Diagnostic.Category)
rownames(anno) <- colnames(ras)
pheatmap::pheatmap(t(series_df), cluster_cols = T,color = rev(mapal), scale = "row", annotation_col = anno, show_colnames = F)
```

## RAS adjusted by trans. prob. of path

```{r fig.width = 15}
series_df <- data.frame(
  S0_sum = colSums(ras_prob_path[S0,]),
  Sa_sum = colSums(ras_prob_path[Sa,]),
  Sb_sum = colSums(ras_prob_path[Sb,]),
  Sc_sum = colSums(ras_prob_path[Sc,])
)

anno <- as.data.frame(colData(dds_NBL)$Diagnostic.Category)
rownames(anno) <- colnames(ras)
pheatmap::pheatmap(t(series_df), cluster_cols = T,color = rev(mapal), scale = "row", annotation_col = anno, show_colnames = F)
```

# Differential Gene Expression Analysis

## DEG based on clustering

```{r warning=FALSE, message=FALSE}
FDR <- 0.05


colData(dds_NBL)$cluster <- cl$cluster
colData(dds_NBL)$cluster[which(colData(dds_NBL)$cluster != 1)] <- "0_2_3_4"
colData(dds_NBL)$cluster <- as.factor(colData(dds_NBL)$cluster)
# colData(dds_NBL)$cluster <- as.factor(c)
design(dds_NBL) <- ~cluster
dds_NBL <- DESeq2::DESeq(dds_NBL, parallel = TRUE)
# res <- results(dds_NBL, alpha=FDR, name="cluster_2_vs_1")
res <- results(dds_NBL, alpha=FDR, name="cluster_1_vs_0_2_3_4")
library(apeglm)
# res <- lfcShrink(dds_NBL, coef="cluster_2_vs_1", type="apeglm", res=res)
res <- lfcShrink(dds_NBL, coef="cluster_1_vs_0_2_3_4", type="apeglm", res=res)
```

```{r}
# dds_NBL_res <- results(dds_NBL, alpha=FDR)
# 
# summary(res)

dds_NBL_res_df <- as.data.frame(res)

# dds_NBL_res_df <- round(dds_NBL_res_df, 5)

# DT::datatable(dds_NBL_res_df, caption="Neuroblastoma v.s. Ganglioneuroblastoma, DE genes (rounded values)")

# saveRDS(as.data.frame(res), "TARGET_NB_GNB_cl1_vs_cl0234_tbl_res_DESeq.Rds")
```

```{r}
# dds_NBL_res_df <- readRDS("TARGET_NB_GNB_cl1_vs_cl0234_tbl_res_DESeq.Rds")
res_df <- dds_NBL_res_df

res_df <- res_df[-which(is.na(res_df$padj)),]

# add a column of NAs
res_df$diffexpressed <- "NO"
# if log2Foldchange > 0.6 and pvalue < 0.05, set as "UP" 
res_df$diffexpressed[res_df$log2FoldChange > 0.6 & res_df$padj < 0.05] <- "UP"
# if log2Foldchange < -0.6 and pvalue < 0.05, set as "DOWN"
res_df$diffexpressed[res_df$log2FoldChange < -0.6 & res_df$padj < 0.05] <- "DOWN"

res_df$delabel <- NA
res_df$delabel[res_df$diffexpressed != "NO"] <- rownames(res_df)[res_df$diffexpressed != "NO"]



mycolors <- c("blue", "red", "black")
names(mycolors) <- c("DOWN", "UP", "NO")

library(ggrepel)
p <- ggplot(data=res_df, aes(x=log2FoldChange, y=-log10(padj), col=diffexpressed, label=delabel)) +
  geom_point() +
  theme_minimal() +
  geom_text_repel() +
  scale_color_manual(values=c("blue", "black", "red")) +
  geom_vline(xintercept=c(-0.6, 0.6), col="red") +
  geom_hline(yintercept=-log10(0.05), col="red")
plotly::ggplotly(p)

# writexl::write_xlsx(res_df, "TARGET_NB_GNB_cl1_vs_cl0234_tbl_res_DESeq.xlsx")
```

```{r}
res_df <- res_df[order(res_df$log2FoldChange),]
# ann_df <- data.frame(cluster=as.factor(c))
ann_df <- data.frame(cluster=as.factor(colData(dds_NBL)$cluster))
# colData(dds_NBL)$cluster
rownames(ann_df) <- rownames(colData(dds_NBL))
ann_df <- ann_df[order(ann_df$cluster),, drop=FALSE]

genes_UP <- res_df[which(res_df$log2FoldChange > 0.6 & res_df$padj < 0.05), "delabel"]
genes_UP <- genes[!is.na(genes_UP)]
genes_DOWN <- res_df[which(res_df$log2FoldChange < -0.6 & res_df$padj < 0.05), "delabel"]
genes_DOWN <- genes[!is.na(genes_DOWN)]
pheatmap(norm_counts[genes_DOWN,rownames(ann_df)],
         show_colnames = FALSE, 
         cluster_rows = TRUE, 
         cluster_cols = FALSE, 
         scale = "row", 
         annotation_col = ann_df,
         color=colorRampPalette(c("navy", "white", "red"))(50)
         )
```

```{r}
DT::datatable(res_df)
```


```{r}
res_df <- dds_NBL_res_df[which(!is.na(dds_NBL_res_df$padj)),]
res_df <- res_df[order(res_df$padj),]

pheatmap(norm_counts[c("HRG", "APOC3", "CYP2C9", "CCDC198", "FABP1", "NTSR1", "NEUROD6", "OPRK1", "CASC11", "GFY", "PENK"),rownames(ann_df)], cluster_rows = FALSE, cluster_cols = FALSE, annotation_col = ann_df, scale = "row",
         color=colorRampPalette(c("navy", "white", "red"))(50))
```

## Enrichment analysis

### Annotation via topGO

```{r topgoprep}
expressedInAssay <- (rowSums(assay(dds_NBL))>0)
geneUniverseExprENS <- rownames(dds_NBL)[expressedInAssay]
geneUniverseExpr <- rownames(dds_NBL)[match(geneUniverseExprENS, rownames(dds_NBL))]
```

```{r topgorun, results="hide", cache=TRUE}
library("topGO")
library("clusterProfiler")
library("GOplot")
library("pcaExplorer")

DEgenes <- rownames(res_df[res_df$padj < 0.05, ])
DEgenes <- DEgenes[-grep("NA\\.[1:9]*", DEgenes)]
  ann_res_BP <- topGOtable(DEgenes = DEgenes,
               BGgenes = geneUniverseExpr,
               ontology = "BP",
               geneID = "symbol",
               addGeneToTerms=TRUE,
               topTablerows = 500,
               mapping = "org.Hs.eg.db")

# downregulated genes
DEgenes <- rownames(res_df[which(res_df$padj < 0.05 & res_df$log2FoldChange < -0.6), ])
# DEgenes <- DEgenes[-grep("NA\\.[1:9]*", DEgenes)]
  ann_res_BP <- topGOtable(DEgenes = DEgenes,
               BGgenes = geneUniverseExpr,
               ontology = "BP",
               geneID = "symbol",
               addGeneToTerms=TRUE,
               topTablerows = 500,
               mapping = "org.Hs.eg.db")
ann_res_BP$GeneRatio <- ann_res_BP$Significant / ann_res_BP$Annotated
ann_res_BP <- ann_res_BP[which(ann_res_BP$p.value_elim<0.05),]
DT::datatable(ann_res_BP)
writexl::write_xlsx(ann_res_BP, "TARGET_NB_GNB_cl1_vs_cl0234_tbl_downreg_res_GO.xlsx")
  
# upregulated genes
DEgenes <- rownames(res_df[which(res_df$padj < 0.05 & res_df$log2FoldChange > 0.6), ])
# DEgenes <- DEgenes[-grep("NA\\.[1:9]*", DEgenes)]
ann_res_BP <- topGOtable(DEgenes = DEgenes,
               BGgenes = geneUniverseExpr,
               ontology = "BP",
               geneID = "symbol",
               addGeneToTerms=TRUE,
               topTablerows = 2000,
               mapping = "org.Hs.eg.db")
ann_res_BP$GeneRatio <- ann_res_BP$Significant / ann_res_BP$Annotated
ann_res_BP <- ann_res_BP[which(ann_res_BP$p.value_elim<0.05),]
DT::datatable(ann_res_BP)
writexl::write_xlsx(ann_res_BP, "TARGET_NB_GNB_cl1_vs_cl0234_tbl_upreg_res_GO.xlsx")



ann_res_BP_plot <- topGOtable(DEgenes = DEgenes,
             BGgenes = geneUniverseExpr,
             ontology = "BP",
             geneID = "symbol",
             addGeneToTerms=TRUE,
             topTablerows = 500,
             mapping = "org.Hs.eg.db",
             plotGraph=TRUE,
             plotNodes = 20)
class(ann_res_BP_plot)


dotplot(ann_res_BP)
```

```{r dtenrich1}
ann_res_BP$GeneRatio <- ann_res_BP$Significant / ann_res_BP$Annotated
# ann_res_BP <- ann_res_BP[order(ann_res_BP$GeneRatio),]
DT::datatable(ann_res_BP[which(ann_res_BP$p.value_elim<0.05 & ann_res_BP$Significant>1),])
```

```{r}
ann_res_BP <- ann_res_BP[which(ann_res_BP$p.value_elim<0.05),]
ann_res_BP <- ann_res_BP[which(ann_res_BP$Significant>1),]

ggplot(ann_res_BP[c(which(ann_res_BP$GeneRatio > 0.2), grep("lipid", ann_res_BP$Term)),], aes(x=GeneRatio, y=reorder(Term,GeneRatio), size=Significant)) + 
# ggplot(ann_res_BP, aes(x=GeneRatio, y=reorder(Term,GeneRatio), size=Significant)) + 
  # geom_vline(xintercept = 0, colour="lightgray", linetype="solid") +
  # geom_errorbar(aes(xmin=mean - sd,xmax=mean + sd,width=0.2)) +
  geom_point(aes(color=-log10(p.value_elim))) +
  colorspace::scale_color_continuous_sequential(palette = "Reds 3") +
  # facet_wrap(~group, ncol = 3, scales="free_x") + 
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor.y = element_line()) +
  ylab("") + xlab("GeneRatio") + labs(size="Significant genes")

ggplot(ann_res_BP[c(which(ann_res_BP$GeneRatio > 0.2), grep("lipid", ann_res_BP$Term)),], aes(x=reorder(Term,-GeneRatio), y=GeneRatio, size=Significant)) + 
# ggplot(ann_res_BP, aes(x=GeneRatio, y=reorder(Term,GeneRatio), size=Significant)) + 
  # geom_vline(xintercept = 0, colour="lightgray", linetype="solid") +
  # geom_errorbar(aes(xmin=mean - sd,xmax=mean + sd,width=0.2)) +
  geom_point(aes(color=-log10(p.value_elim))) +
  colorspace::scale_color_continuous_sequential(palette = "Reds 3") +
  # facet_wrap(~group, ncol = 3, scales="free_x") + 
  theme_classic() +
  theme(panel.grid.major.x = element_line(),
        panel.grid.minor.x = element_line(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        plot.margin = margin(l = 140, r = 10, t =10),
        legend.box.margin = margin(t =50),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)) +
  ylab("GeneRatio") + xlab("") + labs(size="Significant genes")
# +
#   theme(panel.grid.major.y = element_line(color = "lightgray",
#                                           size = 0.5,
#                                           linetype = 1)) + xlab("")

ggplot(ann_res_BP[grep("lipid", ann_res_BP$Term),], aes(x=GeneRatio, y=reorder(Term,GeneRatio), size=Significant)) + 
# ggplot(ann_res_BP, aes(x=GeneRatio, y=reorder(Term,GeneRatio), size=Significant)) + 
  # geom_vline(xintercept = 0, colour="lightgray", linetype="solid") +
  # geom_errorbar(aes(xmin=mean - sd,xmax=mean + sd,width=0.2)) +
  geom_point(aes(color=-log10(p.value_elim))) +
  colorspace::scale_color_continuous_sequential(palette = "Reds 3") +
  # facet_wrap(~group, ncol = 3, scales="free_x") + 
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor.y = element_line()) +
  ylab("") + xlab("GeneRatio") + labs(size="Significant genes")

ann_res_BP[grep("temperature", ann_res_BP$Term), "Term"] <- "DTS involved in sensory perception of pain"

ggplot(ann_res_BP, aes(x=reorder(Term,-GeneRatio), y=GeneRatio, size=Significant)) + 
# ggplot(ann_res_BP, aes(x=GeneRatio, y=reorder(Term,GeneRatio), size=Significant)) + 
  # geom_vline(xintercept = 0, colour="lightgray", linetype="solid") +
  # geom_errorbar(aes(xmin=mean - sd,xmax=mean + sd,width=0.2)) +
  geom_point(aes(color=-log10(p.value_elim))) +
  colorspace::scale_color_continuous_sequential(palette = "Reds 3") +
  # facet_wrap(~group, ncol = 3, scales="free_x") + 
  theme_classic() +
  theme(panel.grid.major.x = element_line(),
        panel.grid.minor.x = element_line(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        plot.margin = margin(l = 140, r = 10, t =10),
        legend.margin = margin(t =10),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)) +
  ylab("GeneRatio") + xlab("") + labs(size="Significant genes")

ggplot(ann_res_BP, aes(x=GeneRatio, y=reorder(Term,GeneRatio), size=Significant)) + 
# ggplot(ann_res_BP, aes(x=GeneRatio, y=reorder(Term,GeneRatio), size=Significant)) + 
  # geom_vline(xintercept = 0, colour="lightgray", linetype="solid") +
  # geom_errorbar(aes(xmin=mean - sd,xmax=mean + sd,width=0.2)) +
  geom_point(aes(color=-log10(p.value_elim))) +
  colorspace::scale_color_continuous_sequential(palette = "Reds 3") +
  # facet_wrap(~group, ncol = 3, scales="free_x") + 
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor.y = element_line(),
        # axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        # plot.margin = margin(l = 150, t =10),
        # legend.margin = margin(t =10),
        axis.text = element_text(size = 20),
        axis.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20)) +
  ylab("") + xlab("GeneRatio") + labs(size="Significant genes")

```

# Enrichment map

```{r}
library(GeneTonic)

# downregulated GO terms
DEgenes <- rownames(res_df[which(res_df$padj < 0.05 & res_df$log2FoldChange < -0.6), ])
# DEgenes <- DEgenes[-grep("NA\\.[1:9]*", DEgenes)]
  ann_res_BP <- topGOtable(DEgenes = DEgenes,
               BGgenes = geneUniverseExpr,
               ontology = "BP",
               geneID = "symbol",
               addGeneToTerms=TRUE,
               topTablerows = 1000,
               mapping = "org.Hs.eg.db")
ann_res_BP$GeneRatio <- ann_res_BP$Significant / ann_res_BP$Annotated

ann_obj <- data.frame(gene_name = rowData(dds_NBL)$geneSymbol)
ann_obj$gene_id <- rownames(ann_obj)

res_enrich <- shake_topGOtableResult(ann_res_BP)

em <- GeneTonic::enrichment_map(
  res_enrich = res_enrich,
  res_de = res,
  annotation_obj = ann_obj,
  n_gs = 30,
  gs_ids = NULL,
  overlap_threshold = 0.2,
  scale_edges_width = 100,
  scale_nodes_size = 5
  # color_by = "p.value_elim"
)

em %>% 
  visIgraph() %>% 
  visOptions(highlightNearest = list(enabled = TRUE,
                                     degree = 1,
                                     hover = TRUE),
             nodesIdSelection = TRUE)

distilled <- distill_enrichment(res_enrich,
                                res,
                                ann_obj,
                                n_gs = 60,
                                cluster_fun = "cluster_markov")
DT::datatable(distilled$distilled_table[,1:4])

dg <- distilled$distilled_em 

# defining a color palette for nicer display
colpal <- colorspace::rainbow_hcl(length(unique(V(dg)$color)))[V(dg)$color]
V(dg)$color.background <- scales::alpha(colpal, alpha = 0.8)
V(dg)$color.highlight <- scales::alpha(colpal, alpha = 1)
V(dg)$color.hover <- scales::alpha(colpal, alpha = 0.5)

V(dg)$color.border <- "black"

visNetwork::visIgraph(dg) %>%
  visOptions(highlightNearest = list(enabled = TRUE,
                                     degree = 1,
                                     hover = TRUE),
             nodesIdSelection = TRUE, 
             selectedBy = "membership")
```

```{r}
library(GeneTonic)

# upregulated GO terms
DEgenes <- rownames(res_df[which(res_df$padj < 0.05 & res_df$log2FoldChange > 0.6), ])
# DEgenes <- DEgenes[-grep("NA\\.[1:9]*", DEgenes)]
ann_res_BP <- topGOtable(DEgenes = DEgenes,
               BGgenes = geneUniverseExpr,
               ontology = "BP",
               geneID = "symbol",
               addGeneToTerms=TRUE,
               topTablerows = 2000,
               mapping = "org.Hs.eg.db")
ann_res_BP$GeneRatio <- ann_res_BP$Significant / ann_res_BP$Annotated

ann_obj <- data.frame(gene_name = rowData(dds_NBL)$geneSymbol)
ann_obj$gene_id <- rownames(ann_obj)

res_enrich <- shake_topGOtableResult(ann_res_BP)

em <- GeneTonic::enrichment_map(
  res_enrich = res_enrich,
  res_de = res,
  annotation_obj = ann_obj,
  n_gs = 50,
  gs_ids = NULL,
  overlap_threshold = 0.1,
  scale_edges_width = 100,
  scale_nodes_size = 5
  # color_by = "p.value_elim"
)

em %>% 
  visIgraph() %>% 
  visOptions(highlightNearest = list(enabled = TRUE,
                                     degree = 1,
                                     hover = TRUE),
             nodesIdSelection = TRUE)

distilled <- distill_enrichment(res_enrich,
                                res,
                                ann_obj,
                                n_gs = 60,
                                cluster_fun = "cluster_markov")
DT::datatable(distilled$distilled_table[,1:4])

dg <- distilled$distilled_em 

# defining a color palette for nicer display
colpal <- colorspace::rainbow_hcl(length(unique(V(dg)$color)))[V(dg)$color]
V(dg)$color.background <- scales::alpha(colpal, alpha = 0.8)
V(dg)$color.highlight <- scales::alpha(colpal, alpha = 1)
V(dg)$color.hover <- scales::alpha(colpal, alpha = 0.5)

V(dg)$color.border <- "black"

visNetwork::visIgraph(dg) %>%
  visOptions(highlightNearest = list(enabled = TRUE,
                                     degree = 1,
                                     hover = TRUE),
             nodesIdSelection = TRUE, 
             selectedBy = "membership")
```

#####################


```{r}
library(GO.db)

getAllBPChildren <- function(goids)
{
 ans <- unique(unlist(mget(goids, GOBPCHILDREN), use.names=FALSE))
 ans <- ans[!is.na(ans)]
}

level1_BP_terms <- getAllBPChildren("GO:0006629")     # 23 terms
level2_BP_terms <- getAllBPChildren(level1_BP_terms)  # 256 terms
level3_BP_terms <- getAllBPChildren(level2_BP_terms)  # 3059 terms
level4_BP_terms <- getAllBPChildren(level3_BP_terms)  # 9135 terms
level5_BP_terms <- getAllBPChildren(level4_BP_terms)
level6_BP_terms <- getAllBPChildren(level5_BP_terms)


GO_Terms <- unique(c(level1_BP_terms, level2_BP_terms, level3_BP_terms, level4_BP_terms, level5_BP_terms, level6_BP_terms))
GO_Terms <- unique(c(level1_BP_terms))

DT::datatable(ann_res_BP[which(ann_res_BP$GO.ID %in% GO_Terms),])
```



```{r topgorun, results="hide", cache=TRUE}

for(i in names(myresults_all)) {
  message(i)
  if(nrow(myresults_all[[i]][["tbl_res_DE"]]) > 0) {
  myresults_all[[i]][["topGO_tbl_MF"]] <-
    topGOtable(DEgenes = myresults_all[[i]][["tbl_res_DE"]]$geneSymbol,
               BGgenes = geneUniverseExpr,
               ontology = "MF",
               geneID = "symbol",
               addGeneToTerms=TRUE,
               topTablerows = 500,
               mapping = "org.Hs.eg.db")
  }
}
```

```{r dtenrich1}
DT::datatable(myresults_all$GD2_score_LOW_vs_HIGH$topGO_tbl)
```

```{r dtenrich1}
DT::datatable(myresults_all$GD2_score_LOW_vs_HIGH$topGO_tbl_MF)
```




```{r}
library(fgsea)
pathways.hallmark <- gmtPathways("./data/msigdb_v2023.1.Hs_GMTs/h.all.v2023.1.Hs.symbols.gmt")
pathways.go.bp <- gmtPathways("./data/msigdb_v2023.1.Hs_GMTs/c5.go.bp.v2023.1.Hs.symbols.gmt")
pathways.go.mf <- gmtPathways("./data/msigdb_v2023.1.Hs_GMTs/c5.go.mf.v2023.1.Hs.symbols.gmt")
pathways.kegg <- gmtPathways("./data/msigdb_v2023.1.Hs_GMTs/c2.cp.kegg.v2023.1.Hs.symbols.gmt")

# pathways.go <- gmtPathways("m5.go.bp.v2023.1.Mm.symbols.gmt")
# pathways.reactome <- gmtPathways("m2.cp.reactome.v2023.1.Mm.symbols.gmt")
```

## pathways.go.bp

```{r}
library(GSVA)

NB_gsva.go.bp <- gsva(norm_counts, pathways.go.bp, mx.diff=FALSE)

es_var <- apply(NB_gsva.go.bp, 1, var)
es_var <- sort(es_var, decreasing = TRUE)
```

```{r}
umap_fit <- umap::umap(d  = t(ras_prob_rec), #sample norm_counts
                           method = "naive",
                           n_neighbors = 8,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 123,
                           # transform_state = input$transform_state,
                           verbose = TRUE)


```

```{r}
library("dbscan")

cl <- hdbscan(umap_fit$layout, minPts = 10)

as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             color = as.factor(cl$cluster)))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
```

```{r}
ann_df <- data.frame(Group=colData(dds_NBL)$Diagnostic.Category, MYCN= colData(dds_NBL)$MYCN.status, Hist=colData(dds_NBL)$Histology, cluster=as.factor(cl$cluster))
rownames(ann_df) <- rownames(colData(dds_NBL))
pheatmap(NB_gsva.go.bp, show_colnames = FALSE, annotation_col = ann_df, show_rownames = FALSE)
```


## pathways.kegg

```{r}
library(GSVA)

NB_gsva.kegg <- gsva(norm_counts, pathways.kegg, mx.diff=FALSE)

es_var <- apply(NB_gsva.kegg, 1, var)
es_var <- sort(es_var, decreasing = TRUE)
```

```{r}
umap_fit <- umap::umap(d  = t(ras_prob_rec), #sample norm_counts
                           method = "naive",
                           n_neighbors = 8,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 123,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
# plot(umap_fit$layout)

# as.data.frame(umap_fit$layout) %>%
# ggplot(aes(x = umap_fit$layout[,1],
#            y = umap_fit$layout[,2],
#            label = rownames(umap_fit$layout),
#            color = NB_gsva.go.bp[8,]))+
# colorspace::scale_color_continuous_sequential(palette = "BluYl") +
# geom_point()+
# theme_classic()+
# labs(x = "UMAP1",
#      y = "UMAP2",
#     subtitle = "UMAP plot")



```

```{r}
library("dbscan")

cl <- hdbscan(umap_fit$layout, minPts = 10)

as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             color = as.factor(cl$cluster)))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
```

```{r}
ann_df <- data.frame(Group=colData(dds_NBL)$Diagnostic.Category, MYCN= colData(dds_NBL)$MYCN.status, Hist=colData(dds_NBL)$Histology, cluster=as.factor(cl$cluster))
rownames(ann_df) <- rownames(colData(dds_NBL))
pheatmap(NB_gsva.kegg[,], show_colnames = FALSE, annotation_col = ann_df, show_rownames = TRUE)
```

```{r}
markers <- scran::findMarkers(
    x = NB_gsva.kegg,
    group = as.factor(cl$cluster),
    # group = colData(dds_NBL)$Diagnostic.Category,
    test.type = "t",
    pval.type = "all",
    #restrict = input$restrict,
    #exclude = input$exclude,
    #direction = input$direction,
    #lfc = input$lfc,
    #min.prop = input$min.prop,
    full.stats = TRUE,
    sorted = TRUE
  )

DT::datatable(as.data.frame(markers$`1`))
DT::datatable(as.data.frame(markers$`NB`))

p <- as.data.frame(markers$`1`) %>%
ggplot(aes(x = stats.1.logFC,
             y = -log10(p.value),
           label=rownames(as.data.frame(markers$`1`))))+
  geom_point()+
  theme_classic()+
  labs(x = "logFC",
       y = "-log10(p.value)")
plotly::ggplotly(p)

DT::datatable(as.data.frame(markers$`2`))
```

```{r}
ann_df <- data.frame(Group=colData(dds_NBL)$Diagnostic.Category, MYCN= colData(dds_NBL)$MYCN.status, Hist=colData(dds_NBL)$Histology, cluster=as.factor(cl$cluster))
rownames(ann_df) <- rownames(colData(dds_NBL))

ann_df <- ann_df[order(ann_df$cluster),]
pheatmap(NB_gsva.kegg[rownames(as.data.frame(markers$`1`)[which(as.data.frame(markers$`1`)$p.value <= 0.05),]),rownames(ann_df)], show_colnames = FALSE, annotation_col = ann_df, show_rownames = TRUE, cluster_cols = FALSE, scale="row")
```




## pathways.go.mf

```{r}
library(GSVA)

NB_gsva.go.mf <- gsva(norm_counts, pathways.go.mf, mx.diff=FALSE)

es_var <- apply(NB_gsva.go.mf, 1, var)
es_var <- sort(es_var, decreasing = TRUE)
```

```{r}
umap_fit <- umap::umap(d  = t(ras_prob_rec), #sample norm_counts
                           method = "naive",
                           n_neighbors = 8,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 123,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
# plot(umap_fit$layout)

# as.data.frame(umap_fit$layout) %>%
# ggplot(aes(x = umap_fit$layout[,1],
#            y = umap_fit$layout[,2],
#            label = rownames(umap_fit$layout),
#            color = NB_gsva.go.mf[8,]))+
# colorspace::scale_color_continuous_sequential(palette = "BluYl") +
# geom_point()+
# theme_classic()+
# labs(x = "UMAP1",
#      y = "UMAP2",
#     subtitle = "UMAP plot")



```

```{r}
library("dbscan")

cl <- hdbscan(umap_fit$layout, minPts = 10)

as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             color = as.factor(cl$cluster)))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
```

```{r}
ann_df <- data.frame(Group=colData(dds_NBL)$Diagnostic.Category, MYCN= colData(dds_NBL)$MYCN.status, Hist=colData(dds_NBL)$Histology, cluster=as.factor(cl$cluster))
rownames(ann_df) <- rownames(colData(dds_NBL))
pheatmap(NB_gsva.go.mf, show_colnames = FALSE, annotation_col = ann_df, show_rownames = FALSE)
```

## pathways.hallmark

```{r}
library(GSVA)

NB_gsva.hall <- gsva(norm_counts, pathways.hallmark, mx.diff=FALSE)

es_var <- apply(NB_gsva.hall, 1, var)
es_var <- sort(es_var, decreasing = TRUE)
```

```{r}
umap_fit <- umap::umap(d  = t(ras_prob_rec), #sample norm_counts
                           method = "naive",
                           n_neighbors = 8,
                           # n_components = input$n_components,
                           # metric  = input$select_metric,
                           # n_epochs = input$n_epochs,
                           # init = input$select_init,
                           # min_dist= input$min_dist,
                           random_state = 123,
                           # transform_state = input$transform_state,
                           verbose = TRUE)
# plot(umap_fit$layout)

# as.data.frame(umap_fit$layout) %>%
# ggplot(aes(x = umap_fit$layout[,1],
#            y = umap_fit$layout[,2],
#            label = rownames(umap_fit$layout),
#            color = NB_gsva.hall[8,]))+
# colorspace::scale_color_continuous_sequential(palette = "BluYl") +
# geom_point()+
# theme_classic()+
# labs(x = "UMAP1",
#      y = "UMAP2",
#     subtitle = "UMAP plot")



```

```{r}
library("dbscan")

cl <- hdbscan(umap_fit$layout, minPts = 10)

as.data.frame(umap_fit$layout) %>%
  ggplot(aes(x = umap_fit$layout[,1],
             y = umap_fit$layout[,2],
             color = as.factor(cl$cluster)))+
  geom_point()+
  theme_classic()+
  labs(x = "UMAP1",
       y = "UMAP2",
      subtitle = "UMAP plot")
```

```{r}
ann_df <- data.frame(Group=colData(dds_NBL)$Diagnostic.Category, MYCN= colData(dds_NBL)$MYCN.status, Hist=colData(dds_NBL)$Histology, cluster=as.factor(cl$cluster))
rownames(ann_df) <- rownames(colData(dds_NBL))
pheatmap(NB_gsva.hall, show_colnames = FALSE, annotation_col = ann_df, show_rownames = T)
```

```{r}
markers <- scran::findMarkers(
    x = NB_gsva.hall,
    # group = as.factor(cl$cluster),
    group = colData(dds_NBL)$Diagnostic.Category,
    test.type = "t",
    pval.type = "all",
    #restrict = input$restrict,
    #exclude = input$exclude,
    #direction = input$direction,
    #lfc = input$lfc,
    #min.prop = input$min.prop,
    full.stats = TRUE,
    sorted = TRUE
  )

DT::datatable(as.data.frame(markers$`NB`))

p <- as.data.frame(markers$`2`) %>%
ggplot(aes(x = stats.1.logFC,
             y = -log10(p.value),
           label=rownames(as.data.frame(markers$`2`))))+
  geom_point()+
  theme_classic()+
  labs(x = "logFC",
       y = "-log10(p.value)")
plotly::ggplotly(p)

as.data.frame(umap_fit$layout) %>%
ggplot(aes(x = umap_fit$layout[,1],
           y = umap_fit$layout[,2],
           label = rownames(umap_fit$layout),
           color = NB_gsva.hall["HALLMARK_KRAS_SIGNALING_DN",]))+
colorspace::scale_color_continuous_sequential(palette = "BluYl") +
geom_point()+
theme_classic()+
labs(x = "UMAP1",
     y = "UMAP2",
    subtitle = "UMAP plot")

DT::datatable(as.data.frame(markers$`2`))
```



# Code for figures:

```{r}
library(plotly)

p1 <- pheatmap(sampleDistMatrix, show_rownames = FALSE, show_colnames = FALSE, annotation_row = ann_df, annotation_names_row=FALSE, annotation_colors = list(Group=c(GNB="#377EB8",NB="#E41A1C"),MYCN=c(Amplified="#FFFF00", `Not.Amplified`="#F6C077")))

p2 <- plotly::plot_ly( showlegend = FALSE, y=norm_counts["MYCN",], x = norm_counts["B3GALT4",], type = "scatter", mode="markers", symbol=colData(dds_NBL)$MYCN.status, color = colData(dds_NBL)$Diagnostic.Category, colors = c("#377EB8","#E41A1C")) %>% 
  plotly::layout(yaxis = list(title = 'log10( MYCN expression )'), 
         xaxis = list(title = 'log10( B3GALT4 expression )')
         #legend = list(x = 0.1, y = 0.1, bordercolor = "#000",bgcolor = "#fff", borderwidth="1")
         )

p3 <- plotly::plot_ly( showlegend = FALSE, y=norm_counts["MYCN",], x = norm_counts["ST8SIA1",], type = "scatter", mode="markers", symbol=colData(dds_NBL)$MYCN.status, color = colData(dds_NBL)$Diagnostic.Category, colors = c("#377EB8","#E41A1C")) %>% 
  plotly::layout(yaxis = list(title = 'log10( MYCN expression )'), 
         xaxis = list(title = 'log10( ST8SIA1 expression )'))
         
p4 <- plotly::plot_ly(y=norm_counts["MYCN",], x = norm_counts["B4GALNT1",], type = "scatter", mode="markers", symbol=colData(dds_NBL)$MYCN.status, color = colData(dds_NBL)$Diagnostic.Category, colors = c("#377EB8","#E41A1C")) %>% 
  plotly::layout(yaxis = list(title = 'log10( MYCN expression )'), 
         xaxis = list(title = 'log10( B4GALNT1 expression )'))

# p4 <- plotly::plot_ly(y=norm_counts["MYCN",], x = norm_counts["UGCG",], type = "scatter", mode="markers", symbol=colData(dds_NBL)$MYCN.status, color = colData(dds_NBL)$Diagnostic.Category, colors = c("#377EB8","#E41A1C")) %>% 
#   plotly::layout(yaxis = list(title = 'log10( MYCN expression )'), 
#          xaxis = list(title = 'log10( UGCG expression )'))


fig <- subplot(p2, p3, p4, shareY = TRUE, titleX = TRUE)

library(multipanelfigure)
library(grid)
cols <- 1
rows <- 2
figure <- multi_panel_figure(
  width = 225,
  columns = cols,
  height = 220,
  rows = rows)
figure %<>% fill_panel(p1)
figure %<>% fill_panel(fig)
 figure

save_multi_panel_figure(figure, "NB_GN_UMAP_cluster.png", dpi = 300)
```


# Session Info

```{r}
sessionInfo()
```


